立ち絵5表情・一括生成アプリ 仕様書（Cloud Run デプロイ対応・完全版）

ゴール：チャットでキャラ見た目を収集→JSON化→NanoBananaに“1リクエストで5表情”の立ち絵（白背景・全身）を生成→rembgで透過→ダウンロード。
フロントエンドから Docker 化 → Cloud Run にそのままデプロイできる構成です。色は**「ペール／ライトグレイッシュ／淡いパステル」**で方向付けし、輪郭線は灰色を指定。プロンプトは省略なしで記載。

1. プロダクト概要

名称：Standing-Set-5 (仮)

機能：

チャット式インタビュー（6問＋確認2）

回答をJSON化

NanoBananaに1回の指示で5枚（表情差分）生成（全身・白背景・ラノベ立ち絵）

rembgで背景透過（PNG）

ダウンロード（ZIP / 個別PNG）

ユースケース：Vtuber/ノベル/企画資料/ゲーム立ち絵

2. ユーザーフロー

画面で 6 問のインタビューに回答

送信 → サーバーが JSON を生成

サーバーが NanoBanana へ n=5 / seed固定 / 全身 のプロンプト送信

受け取った 5 画像を rembg に通して透過 PNG 化

5 枚まとめ ZIP を返却（または個別 URL / base64）

3. インタビュー設計（6問＋確認2）

Q1. 年齢感・身長・体格（例：高校生くらい／160cm／華奢）

Q2. 髪（色／長さ／前髪／スタイル／アクセ）

Q3. 顔（目の色／目の形、まつ毛、眉、口、ほくろなどの特徴）

Q4. 服装（系統＋具体：上／下／小物／靴）

Q5. 性格3語＋役割（例：おっとり・芯が強い・ドジ／神社で手伝う生徒）

Q6. 構図の固定（全身・正面・直立でOK？）

確認A）背景は白、他キャラ・小物・文字・武器なしでOK？

確認B）色はペール＆ライトグレイッシュ／輪郭は灰色ラインで統一してOK？

4. データスキーマ（JSON）
{
  "character_id": "string",
  "seed": 123456789,
  "basic": {
    "age_appearance": "高校生くらい",
    "height_cm": 160,
    "build": "華奢"
  },
  "hair": {
    "color": "アッシュブラウン or シルバーグレー（お好みの自然語）",
    "length": "ロング/セミロング/ショート",
    "bangs": "ぱっつん/斜め/なし",
    "style": "外ハネ/内巻き/ストレート/ツインテ/三つ編みなど",
    "accessories": ["小さなヘアピン", "リボン など"]
  },
  "face": {
    "eyes_color": "灰青/淡いヘーゼル など",
    "eyes_shape": "大きめ/つり目/たれ目 など",
    "eyelashes": "短め/標準/長め",
    "eyebrows": "細め/標準/太め",
    "mouth": "小さめ/標準 など",
    "marks": ["ほくろ位置」など任意"]
  },
  "outfit": {
    "style": "カジュアル/スクール/和×洋ミックス など",
    "top": "具体的な上衣",
    "bottom": "具体的な下衣",
    "accessories": ["ネクタイ/リボン/小物など"],
    "shoes": "ローファー/スニーカーなど"
  },
  "persona": {
    "keywords": ["おっとり", "芯が強い", "ドジ"],
    "role": "神社手伝いの生徒"
  },
  "framing": {
    "shot": "全身",
    "camera": "正面、俯瞰なし、中心に全身が収まる、左右の余白を確保",
    "pose": "直立、両腕は体側、自然体、足元まで映る"
  },
  "constraints": {
    "background": "白",
    "forbid": ["背景小物", "武器", "他キャラ", "文字", "透かし", "テクスチャ", "床影", "強コントラスト"]
  }
}

5. NanoBanana プロンプト（省略なし・全身版・1回で5枚生成）

{{...}} は上記 JSON から差し込み。n=5 / seed同一 / size同一で送信する。
色は数値を使わず「ペール／ライトグレイッシュ／淡いパステル」「灰色ライン」を方向付けとして明示。

【目的】
同一キャラクターのラノベ風立ち絵を5枚同時に生成する。
5枚は人物・髪・衣装・体格・画角・線のタッチを完全一致させ、顔の表情だけを各枚ごとに変更する。
背景は完全に白（#FFFFFF）。質感テクスチャや落ち影は一切入れない。全身が頭からつま先までフレーム内に完全に収まること。

【色調（数値を使わない指定）】
overall color grading: pale tones, light grayish tones, soft muted pastel tones.
airy and slightly hazy atmosphere, emotional pastel look.
no vivid or highly saturated colors, no harsh contrast.
low-contrast tonal range, avoid crushed blacks and clipped whites.

【線（輪郭）】
outline color: soft, desaturated cool gray; not pure black.
outer contour lines: slightly bolder to hold silhouette.
inner facial/detail lines: finer and lighter gray.
consistent, clean, thin lines; no sketchy strokes or messy hatching.

【ライティング】
soft, diffused frontal key light.
gentle ambient light with a cool tint.
shadows should be light grayish, never pure black.
very thin cool rim light for subtle depth.
overall gentle, low-contrast illumination.

【キャラクター固定仕様（全画像共通・厳守）】
年齢感: {{basic.age_appearance}}
身長: {{basic.height_cm}}cm前後 / 体格: {{basic.build}}
髪: {{hair.color}}, {{hair.length}}, 前髪: {{hair.bangs}}, スタイル: {{hair.style}}, アクセ: {{hair.accessories | join(", ")}}
顔: 目色 {{face.eyes_color}}, 目形 {{face.eyes_shape}}, まつ毛 {{face.eyelashes}}, 眉 {{face.eyebrows}}, 口 {{face.mouth}}, 特徴 {{face.marks | join(", ")}}
服装: {{outfit.style}} / 上 {{outfit.top}} / 下 {{outfit.bottom}} / 小物 {{outfit.accessories | join(", ")}} / 靴 {{outfit.shoes}}
性格キーワード: {{persona.keywords | join("・")}} / 役割: {{persona.role}}

【構図・フレーミング（全画像共通・厳守）】
ショット: 全身。頭から足先まで切れずにフレーム内に収める。左右にわずかな余白を取り、中央に配置。
カメラ: 正面、俯瞰なし、50mm相当の自然なパース。レンズ歪みなし。被写界深度は深く、全身にフォーカス。
ポーズ: 直立、肩の力みなし、両腕は体側、指先は自然。足元まで見える。足の向きは正面〜やや内振り程度。
背景: 完全な白 (#FFFFFF)。no texture, no vignette, no gradient, no floor shadow.

【禁止（全画像）】
背景小物、武器、他キャラ、文字、透かし（watermark）、粒子ノイズ、紙テクスチャ、床影・床反射、過度な光沢、強コントラスト、切れフレーミング。

【出力ルール】
- 合計5枚。全画像で同一人物としての一貫性を最優先。
- 差分は「顔の表情のみ」。髪・衣装・体格・ポーズ・画角・線の太さは完全固定。
- 画像順序は #1→#5 の順に返す。

【各画像の表情差分（顔のみ変更）】
#1: ニュートラル — 穏やかな基準表情
    口: 自然 / 眉: 標準 / 目: 標準

#2: 微笑み — 口角をわずかに上げた優しい笑顔
    口: 軽いスマイル / 眉: やや下げ / 目: やや細め

#3: 驚き — 目を丸くして小さく口を開く
    口: 小さく開く / 眉: 上がる / 目: 大きく

#4: 困り顔 — 申し訳なさそうに眉が寄る
    口: への字（小） / 眉: 内側に寄る / 目: やや細め

#5: むすっ — 拗ねたように正面を見据える
    口: 真一文字 / 眉: 下がる / 目: 標準


注意：全身を確実に収めるため、生成サイズは**縦長（例：1024×1536）**を推奨。トリミング防止のため「頭から足先まで」を強調。

6. API 連携（バックエンド設計）

バックエンド：FastAPI (Python)

エンドポイント：

POST /api/generate … インタビュー JSON を受け取り → プロンプト差し込み → NanoBanana (n=5) → rembg → ZIP / base64 返却

GET /api/health … ヘルスチェック

リクエスト例
POST /api/generate
{
  "character": { /* 上記JSON */ },
  "return": "zip"   // "zip" | "base64_list"
}

レスポンス例（zip返却）

Content-Type: application/zip

ファイル名: standing_set_{{character_id}}.zip

同梱: *_expr01.png〜*_expr05.png

7. バックエンド実装（抜粋コード）

requirements.txt

fastapi
uvicorn[standard]
pydantic
requests
rembg
pillow
python-multipart


server/main.py

import os, io, base64, zipfile, tempfile
from fastapi import FastAPI, HTTPException, Response
from pydantic import BaseModel
from typing import List, Dict, Any
import requests
from rembg import remove
from PIL import Image

NANO_URL = "https://api.nanobanana.ai/v1/images/generations"
API_KEY = os.getenv("NANOBANANA_API_KEY")

app = FastAPI()

class Character(BaseModel):
    character_id: str
    seed: int = 123456789
    basic: Dict[str, Any]
    hair: Dict[str, Any]
    face: Dict[str, Any]
    outfit: Dict[str, Any]
    persona: Dict[str, Any]
    framing: Dict[str, Any]
    constraints: Dict[str, Any]

class GenRequest(BaseModel):
    character: Character
    return_: str = "zip"  # "zip" or "base64_list"

@app.get("/api/health")
def health():
    return {"ok": True}

def render_prompt(data: Dict[str, Any]) -> str:
    # ここに「プロンプト（省略なし・全身版）」をそのまま貼り付け、
    # Pythonのf-string等で {{ }} を data[...] に置換してもOK。
    # 実装簡便化のため最小限の置換のみ例示
    def j(xs): return ", ".join(xs) if xs else ""
    d = data
    prompt = f"""
【目的】
同一キャラクターのラノベ風立ち絵を5枚同時に生成する。
5枚は人物・髪・衣装・体格・画角・線のタッチを完全一致させ、顔の表情だけを各枚ごとに変更する。
背景は完全に白（#FFFFFF）。質感テクスチャや落ち影は一切入れない。全身が頭からつま先までフレーム内に完全に収まること。

【色調（数値を使わない指定）】
overall color grading: pale tones, light grayish tones, soft muted pastel tones.
airy and slightly hazy atmosphere, emotional pastel look.
no vivid or highly saturated colors, no harsh contrast.
low-contrast tonal range, avoid crushed blacks and clipped whites.

【線（輪郭）】
outline color: soft, desaturated cool gray; not pure black.
outer contour lines: slightly bolder to hold silhouette.
inner facial/detail lines: finer and lighter gray.
consistent, clean, thin lines; no sketchy strokes or messy hatching.

【ライティング】
soft, diffused frontal key light.
gentle ambient light with a cool tint.
shadows should be light grayish, never pure black.
very thin cool rim light for subtle depth.
overall gentle, low-contrast illumination.

【キャラクター固定仕様（全画像共通・厳守）】
年齢感: {d['basic']['age_appearance']}
身長: {d['basic']['height_cm']}cm前後 / 体格: {d['basic']['build']}
髪: {d['hair']['color']}, {d['hair']['length']}, 前髪: {d['hair']['bangs']}, スタイル: {d['hair']['style']}, アクセ: {j(d['hair'].get('accessories', []))}
顔: 目色 {d['face']['eyes_color']}, 目形 {d['face']['eyes_shape']}, まつ毛 {d['face']['eyelashes']}, 眉 {d['face']['eyebrows']}, 口 {d['face']['mouth']}, 特徴 {j(d['face'].get('marks', []))}
服装: {d['outfit']['style']} / 上 {d['outfit']['top']} / 下 {d['outfit']['bottom']} / 小物 {j(d['outfit'].get('accessories', []))} / 靴 {d['outfit']['shoes']}
性格キーワード: {j(d['persona'].get('keywords', []))} / 役割: {d['persona']['role']}

【構図・フレーミング（全画像共通・厳守）】
ショット: 全身。頭から足先まで切れずにフレーム内に収める。左右にわずかな余白を取り、中央に配置。
カメラ: 正面、俯瞰なし、50mm相当の自然なパース。レンズ歪みなし。被写界深度は深く、全身にフォーカス。
ポーズ: 直立、肩の力みなし、両腕は体側、指先は自然。足元まで見える。足の向きは正面〜やや内振り程度。
背景: 完全な白 (#FFFFFF)。no texture, no vignette, no gradient, no floor shadow.

【禁止（全画像）】
背景小物、武器、他キャラ、文字、透かし（watermark）、粒子ノイズ、紙テクスチャ、床影・床反射、過度な光沢、強コントラスト、切れフレーミング。

【出力ルール】
- 合計5枚。全画像で同一人物としての一貫性を最優先。
- 差分は「顔の表情のみ」。髪・衣装・体格・ポーズ・画角・線の太さは完全固定。
- 画像順序は #1→#5 の順に返す。

【各画像の表情差分（顔のみ変更）】
#1: ニュートラル — 穏やかな基準表情
    口: 自然 / 眉: 標準 / 目: 標準

#2: 微笑み — 口角をわずかに上げた優しい笑顔
    口: 軽いスマイル / 眉: やや下げ / 目: やや細め

#3: 驚き — 目を丸くして小さく口を開く
    口: 小さく開く / 眉: 上がる / 目: 大きく

#4: 困り顔 — 申し訳なさそうに眉が寄る
    口: への字（小） / 眉: 内側に寄る / 目: やや細め

#5: むすっ — 拗ねたように正面を見据える
    口: 真一文字 / 眉: 下がる / 目: 標準
"""
    return prompt.strip()

def nano_generate(prompt: str, seed: int, width=1024, height=1536) -> List[bytes]:
    if not API_KEY:
        raise HTTPException(500, "NANOBANANA_API_KEY is not set")
    payload = {
        "prompt": prompt,
        "n": 5,
        "seed": seed,
        "width": width,
        "height": height
    }
    r = requests.post(
        NANO_URL,
        headers={"Authorization": f"Bearer {API_KEY}", "Content-Type": "application/json"},
        json=payload,
        timeout=300
    )
    if r.status_code >= 400:
        raise HTTPException(r.status_code, f"NanoBanana error: {r.text}")
    data = r.json()
    images = []
    # 仕様に合わせて調整：ここでは base64 フィールド例
    for item in data.get("images", []):
        b = base64.b64decode(item["b64_json"])
        images.append(b)
    if len(images) != 5:
        raise HTTPException(500, "Expected 5 images from NanoBanana")
    return images

def remove_bg(png_bytes: bytes) -> bytes:
    with Image.open(io.BytesIO(png_bytes)) as im:
        out = remove(im)
        buf = io.BytesIO()
        out.save(buf, format="PNG")
        return buf.getvalue()

@app.post("/api/generate")
def generate(req: GenRequest):
    d = req.character.dict()
    prompt = render_prompt(d)
    raws = nano_generate(prompt, seed=d.get("seed", 123456789))
    processed = [remove_bg(b) for b in raws]

    if req.return_ == "base64_list":
        return {"images": [base64.b64encode(p).decode() for p in processed]}

    # zipで返す
    mem = io.BytesIO()
    with zipfile.ZipFile(mem, "w", zipfile.ZIP_DEFLATED) as z:
        for i, p in enumerate(processed, 1):
            z.writestr(f"{d['character_id']}_expr{i:02}.png", p)
    mem.seek(0)
    headers = {
        "Content-Disposition": f"attachment; filename=standing_set_{d['character_id']}.zip"
    }
    return Response(content=mem.read(), media_type="application/zip", headers=headers)

8. フロントエンド（最小要件）

技術：React + Vite（または Next.js でも可）

画面：

左：チャット式インタビュー（6問＋確認2）

右：回答の JSON プレビュー

生成ボタン → 進捗表示 → ZIP ダウンロード

バリデーション：身長は 120–200cm 程度、必須項目チェック

送信：/api/generate に JSON POST

Claude Code を使う場合は、上記要件と API スキーマを README に書いて対話生成→微修正の流れが速い。

9. ファイル命名・出力

{character_id}_expr01.png 〜 expr05.png

ZIP：standing_set_{character_id}.zip

後工程（Live2D/Unity等）で扱いやすいよう背景透過PNGを採用

10. セキュリティ・運用

APIキー：NANOBANANA_API_KEY は Cloud Run の 環境変数として設定（コードに直書き禁止）

レート制御：1ユーザーあたり同時1ジョブ、キュー/簡易トークンバケット

ファイル保管：Cloud Run はエフェメラル。長期保管は GCS（オプション）

ログ：プロンプト全文・レスポンスサイズ・失敗時のステータス記録（PIIは持たない）

11. Docker 化

Dockerfile

FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

WORKDIR /app
COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

COPY server ./server

ENV PORT=8080
EXPOSE 8080

CMD ["uvicorn", "server.main:app", "--host", "0.0.0.0", "--port", "8080"]


ローカル起動

docker build -t standing-set .
docker run -e NANOBANANA_API_KEY=xxxxx -p 8080:8080 standing-set
curl http://localhost:8080/api/health

12. Cloud Run デプロイ

ビルド＆デプロイ

gcloud builds submit --tag gcr.io/$(gcloud config get-value project)/standing-set

gcloud run deploy standing-set \
  --image gcr.io/$(gcloud config get-value project)/standing-set \
  --platform managed \
  --region asia-northeast1 \
  --allow-unauthenticated \
  --set-env-vars NANOBANANA_API_KEY=YOUR_KEY


エンドポイント確認

SERVICE_URL=$(gcloud run services describe standing-set --region asia-northeast1 --format 'value(status.url)')
echo $SERVICE_URL
curl "$SERVICE_URL/api/health"


画像長期保存をしたいなら、GCSバケットを作成し GOOGLE_APPLICATION_CREDENTIALS を設定、生成PNGをアップロードする処理を追加。

13. テスト観点（抜粋）

全身収まり：頭〜つま先が切れないか

5枚一貫性：輪郭太さ・髪型・衣装・体格・画角が一致

表情差分のみ：ポーズが勝手に変わってないか

透過精度：髪先のフリンジや半透明縁の破綻確認

失敗系：NanoBanana API 4xx/5xx、タイムアウト、画像数不足時のリトライ/エラー返却

14. 追加の小ワザ

seed固定＋サイズ固定（例：1024×1536）で安定

どうしてもトリミングされる場合は、さらに余白要求（「全身に余白を確保」「足下に余白」など）を追記

負例（negative）を増やし過ぎると自由度が下がるので、必要最低限に抑える

